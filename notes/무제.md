## 블록체인의 이해(상) - 기본개념

먼저 본 글에 앞에서 이 글은 초코파이 개발자 orionjeong의 지식공유 글로 완벽하지 않을 수 있으니 언제라도 잘 못된 내용이 있으면 바로 잡아 주셨으면 합니다. 

한 가지 주의사항이 있다면 밑의 내용들은 대부분 첫 블록체인의 성공사례인 비트코인에 대한 예시들입니다. 블록체인의 이해(하)편에서는 비트코인의 문제점들과 이러한 문제점을 해결하기위한 노력들 또는 현재의 블록체인의 문제점과 해결하기 위한 방안들에 대한 얘기를 해보려고 합니다.  

#### 1. 블록체인의 탄생 배경

먼저 블록체인에 대해서 알아보자. 위키 백과에 따른 블록체인의 뜻은 아래와 같다.

> 블록체인은 관리 대상 데이터를 '블록'이라고 하는 소규모 데이터들이 P2P 방식을 기반으로 생성된 체인 형태의 연결고리 기반 분산 데이터 저장환경에 저장되어 누구라도 임의로 수정할 수 없고 누구나 변경의 결과를 열람할 수 있는 분산 컴퓨팅 기술 기반의 데이터 위변조 방지 기술이다.

굉장히 심오하다. 여기서 중요한 점은 분산 데이터 저장환경에 저장이다. 

즉 탈중앙화(Decentralized)되어 있다는 뜻이다. 그렇다면 기존의 중앙화된 서비스의 문제점은 무엇이길래 블록체인이 탄생하게 되었을까? 



###### 1.1 기존 서비스와 블록체인의 비교 

![image-20181028153115531](/Users/veo/Library/Application Support/typora-user-images/image-20181028153115531.png)

(자료 인용 - https://m.blog.naver.com/n_privacy/221221982953 네이버 정보보호 블로그)

기존의 서비스는 중앙화된 하나의 신뢰기관이 존재한다.(여기서의 신뢰란 맹목적인 믿음이다.) 그 신뢰기관을 통하여 우리는 거래를 할 수 있게되고 그 기록들은 신뢰기관에 기록되게 된다. 하지만 여기에는 문제점들이 몇 가지가 있습니다. 

- 기존서비스의 단점 
  1. 수수료가 존재한다.
  2. 은행서버가 터지거나 데이터가 삭제된다면 답이 없다.(실제로는 이러한 일을 미연에 방지하기 위해 다양한 대처 방법들이 존재 but 완벽하지는 않다.)
  3. 신뢰기관이 고의적으로 악의적인 짓을 할 수 있다.(ex통화량 조절, )
  4. 신뢰기관이 데이터를 독점한다.(확인가능, 변경가능의 여지를 준다.)



이런 문제점들 때문에 비트코인을 만든 사카시 나카모토(Satoshi Nakamoto)는 중앙화된 신뢰기관을 없애기 위해 비트코인(bitcoin)을 만들게 됩니다. 

> 사카시 나카모토에 대한 여담
>
> 2008년 10월에 "Bitcoin: A Peer-to-Peer Electronic Cash System"이라는 제목의 9쪽짜리 논문을 공개 
>
> 2009년도에 Bitcoin Core 프로그램이 공개되며 2009년 1월 3일에 비트코인을 처음 발행하였다.



여기서 비트코인과 블록체인간의 관계를 간단히 정리하면 

> 비트코인은 블록체인이라는 분산화 된 장부 네트워크 안에서 돌아가는 가상화폐라고 할 수 있습니다. 
>
> 그리고 비트코인은 2가지 방법으로 얻을 수 있는데 방법은 다음과 같습니다 	.
>
> 1. 채굴 - 트랜잭션들을 검증해주고 그 대가로 보상과 거래의 수수료를 비트코인으로 얻는 방법
> 2. 거래 - 블록체인 네트워크 안에서 가상화폐를 거래하는 경우 

블록체인네트워크를 유지하기(채굴) 위해 보상으로써 받을 수 있는 비트코인에 대한 설명은 조금 이따가 더 자세히 설명하도록 하겠습니다. 



------



#### 2. 분산화된 시스템(블록체인)의 문제점과 해결방안(비트코인)



위에서의 내용으로 블록체인을 이용하려는 배경은 알 수 있었습니다. 그렇다면 기존의 중앙화된 신뢰기관이 하던 일을 분산화된 시스템에서 어떻게 처리할 수 있을까요??



**분산화된 환경을 어떻게 만들고 신뢰 주체 없이 디지털 자산을 어떻게 이동시킬 수 있을까요?**

- 분산화된 환경만들기

  신뢰주체 대신에 P2P네트워크를 구축하여 분산화된 환경을 만들 수 있습니다.

- 신뢰 주체 없이 믿을 수 있는 디지털 자산 이동시키기

  모든 참여자의 트랜잭션을 저장및 공유하고 검증하는 아이디어를 통해 데이터의 위변조 방지를 방지하는 환경을 만듭니다.

위의 결과물로 만들어 진 것이 **분산원장**입니다. 

그럼 문제가 해결되었나요? 아직 많이 남았습니다...... 



**이중지불 문제**



> 이중지불 문제란 A라는 사람의 잔고에 1000원이 남았을때  A가 B라는 사람과 C라는 사람에게 동시에 1000원씩 지불하는 문제를 말합니다. 

물론 기존의 시스템에서는 중앙화된 신뢰기관(은행)을 통해서 거래를 하기 때문에 기록이 은행database에 남아 순서가 기록됨으로써 만약 A ->B 거래가 먼저 데이터베이스에 쌓이면 A -> C를 보내기전 잔액이 0원이 되어 해결이 됩니다. 

하지만 은행처럼 신뢰기관이 없는 블록체인에서는 누가 트랜잭션의 순서를 결정할까요?? 

이를 해결하기 위해 신뢰주체가 없는 P2P환경의 블록체인에서 트랜잭션의 순서를 정하는 것을 합의하는 것이 **합의 알고리즘**(**Consensus**)이라고 하며 블록체인에서 핵심개념입니다. 



**합의 알고리즘(Consensus)**



블록체인에는 아래와 같이 많은 합의 알고리즘이 존재합니다. 

1. 작업증명(Proof-of-Work) - 컴퓨팅 파워와 시간이 필요한 작업 증명을 완료한 노드에게 트랜잭션들의 순서를 결정할 권한을 부여한다. 

2. 지분증명(Proof-of-Stake) - 디지털 자산이 많은 노드에 트랜잭션 순서를 결정할 권한을 부여한다.  직접 민주주의를 생각하면 된다. 

3. 위임지분증명(Delegated-Proof-of-Stake) - 지분을 갖고 있는 사람 중 제한된 수의 사람을 믿자

   간접 민주주의로 생각하면 된다. 

4. 다수결원칙 (Practical-Byzantine-Fault-Tolerance) - 다수의 의사결정을 믿자 

5. 승인된 계정에 의한 증명 (Proof-of-Authority) - 확실한 신원에 기반한 합의 방식을 통해서 즉각적인 거래를 제공하는 합의 방식

여기서는 대표적으로 비트코인, 이더리움에서 쓰고있는 PoW(Proof-of-Work)를 통해서 설명드리려 합니다.

PoW는 컴퓨팅 파워와 시간이 필요한 작업증명을 완료한 노드에게 트랜잭션들의 순서를 결정할 권한을 준다고 했습니다. 어떤식으로 순서를 결정할 수 있을까요? 

다음 내용은 **채굴**과 연관지어서 설명하도록 하겠습니다. 



**채굴 **



여기서 잠깐!! 블록에 대한 정의부터 해야겠습니다.

> 블록이란 쉽게 말하면 거래 정보의 묶음이다. 그리고 이 정보묶음을 유효하게 만들려면 블록체인에 연결해야한다. 

비트 코인의 블록 하나에는 평균 약 1,800개의 거래 정보가 포함될 수 있으며, 블록 하나의 물리적인 크기는 평균 0.98Mbyte입다.

거래에 의해 트랜잭션들이 생겨나게 되면 아직 컨펌되지 않은 트랜잭션으로 현재 생성 대기중인 블록에 쌓이게 됩니다. 

![image-20181028184347063](/Users/veo/Library/Application Support/typora-user-images/image-20181028184347063.png)

현재 생성대기중인 블록은 이미 블록헤더의 6가지(소프트웨어 버전, 바로 앞 블록의 블록해쉬, 머클트리해쉬, 블록 생성시각, 채굴 난이도, Nonce)중 앞의 5가지는 이미 확정되어있고 확정되지 않은 nonce값을 토대로 해쉬값이 특정 값 이하가 되는 nonce값을 구해야하며 이를 흔히 작업증명(Proof of Work)라고 말하고 값을 구하는 행위를 **채굴** 행위라고 할 수 있습니다. 

이런 작업을 도대체 누가할까요?? 자신의 컴퓨팅 파워와 시간을 쓰면서 이걸 누가 하려고 할까요?? 아무도 안하죠.. 그래서 **보상**이 필요합니다. 블록을 생성해준 보상과 거래 수수료를 받아야 이런 일을 할 것입니다. 그래서 **보상으로 비트코인을 주는 것**이고 이게 바로 블록체인과 가상화폐를 뗄 수 있느냐 없느냐의 문제로 까지 직결하게 되는 것입니다. 만약 보상을 주지않으면 블록체인 네트워크가 돌아가지 않을 테니까요… 



이렇게 블록이 블록체인에 등록하게 되면 블록에 기록된 트랜잭션들의 순서가 정해지게 됩니다. 

요약하자면 

> **컴퓨팅 파워와 시간이 필요한 작업증명을 행한 채굴자**가 nonce값을 맞춰서 블록을 등록하면 **새로 등록된 블록에 기록된 트랜잭션들의 순서가 유효**해지는 것입니다. 그렇게 되면 이중지불에 대한 문제도 블록에 기록된 트랜잭션의 순서에 의해 해결할 수 있습니다. 그리고 채굴자가 이런 일들을 하도록 하기 위해서 보상으로 **비트코인**을 주는 것입니다. 

이에 대한 내용은 https://homoefficio.github.io/에 아주 자세히 나와있습니다. 꼭 한 번 읽어보세요 



어느정도 이해가 되셨나요??  그런데 여기서 하나의 의문점이 듭니다. 

**왜? 굳이 컴퓨팅 파워와 시간이 필요한 작업증명을 통해서 트랜잭션 순서를 합의해야할까?**

다른 쉬운 합의방법은 없었을까? 

여기서 질문에 대한 해답은 유명한 **비잔티움 장군 문제**를 통해서 알 수 있습니다.



**비잔티움 장군 문제**

![image-20181028185605242](/Users/veo/Library/Application Support/typora-user-images/image-20181028185605242.png)

> 비잔티움 장군 문제는 가운데 한 성이 있고 이를 함락해야하는 5개의 부대를 생각하면 된다. 
>
> 각 부대는 전령을 통해 교신해야 하고 중간에 적에게 잡히고 전파하고자 한 약속(데이터)가 위변조 될 수 있고 부대중에는 배신자가 있을 수 있다. 이러한 상황에서 배신자가 데이터를 위변조하더라도 거짓임을 알고 본래의 메세지를 확인할 수 있도록 해야한다. 

즉 비잔티움 장군 문제는 블록체인처럼 누구도 신뢰할 수 없는 분산 환경에서 하나의 노드에서 악의적인 공격이나 통신의 문제로 데이터에 문제가 생겼을 때를 말하고  블록체인은 이러한 오류를 사전에 방지할 수 있어야 합니다. 그리고 이러한 방지는 **합의 알고리즘**에 녹아들어 있어야 합니다.

요약하자면 

> 합의 알고리즘은 트랜잭션의 순서를 합의하는 것이고 이러한 알고리즘들은 비잔티움 장군문제를 해결할 수 있어야 한다.



**PoW로 비잔티움 장군 문제 해결하기**



그렇다면 PoW합의 알고리즘에서는 이 비잔티움 장군문제를 어떻게 해결하는지 알아보도록 하겠습니다. 

1. 먼저 A, B, C, D, E부대가 있고 C부대는 배신자라고 가정하도록 하겠습니다. 
2. 4부대가 한 번에 성을 공격해야 이길 수 있습니다. 
3. 부대들은 메시지를 보내기 위해 반드시 10분의 시간이 필요함
4. 메시지는 모든 이전 장군의 메시지와 10분의 시간을 들였다는 증거를 포함하여 보내야 함



- A는 B에게 아침 9시에 공격하자는 메시지를 적어 10분간 작업한 증거와 함께 B에게 보냅니다.
- B는 A에게 받은 메시지와 10분간 작업한 증거를 보고 확신 한 후, C에게 아침 9시에 공격하자는 메세지를 10분간 작업한 증거와 함께 C에게 보냅니다.
- C는 배신자입니다. 배신자는 다 같이 공격할 수 없도록 8시에 공격하자는 메세지를 최대한 빨리 만들어서 보내려고 하지만 A와 B의 메세지를 위조하지는 못합니다. 방법은 나머지 시간동안 추가로 작업하여 A와 B의 20분의 작업량에 해당하는 메세지도  위조하는 방법밖에 없습니다. 즉 변경 불가능 하기에 자신의 메세지만 변경한다면 위조를 발각당합니다. 

여기서 10분의 시간을 들였다는 증거는 **PoW**이며 이전 메세지를 포함한 새로운 메시지는 **블록체인**입니다. 

실제로 비트코인에서 블록을 만들기 위해서는 대략 10분정도의 시간을 들여야 합니다. 

아직 문제가 끝나지 않았습니다.....



**블록 체인의 충돌**



새로운 블록체인이 생성이 되면 모든 노드들에 이 사실을 알리기 위해서 가십 프로토콜(epidemic protocol)을 통해서 데이터가 전파됩니다. 하지만 데이터가 완전히 전파되려면 시간이 걸립니다. 

만약 우연히 두개 이상의 노드들에 의해 서로 멀리 떨어진 곳에서 블록을 생성하게 된다면 서로 전파가 되면서 노드들의 일관성이 깨지게 됩니다. 

![image-20181028194037363](/Users/veo/Library/Application Support/typora-user-images/image-20181028194037363.png)

또한 새로생성된 블록들의 거래 순서 또한 다를 수 있습니다. 

![image-20181028194143115](/Users/veo/Library/Application Support/typora-user-images/image-20181028194143115.png)



예를 들어 빨간 노드의 근처 노드들은 전달 받은 빨강블록의 블록 해쉬를 계산해서 특정한 값보다 작은 값인지 검증한 후에, 자신이 가지고 있던 파랑블록에 빨강블록을 추가합니다. 

파란 노드의 인접한 노드들도 마찬가지로 초록 노드를 검증하고 파랑노드에 추가합니다. 이런 식으로 반복해서 작업을 하다보면 일관성을 잃은채로 전세계로 퍼지게 됩니다.



**블록체인의 충돌을 해결하기 위한 나카모토 컨센서스**



![image-20181028194726690](/Users/veo/Library/Application Support/typora-user-images/image-20181028194726690.png)

이런 와중에 분홍블록이 생성되게 되고 분홍 블록 근처에 있던 노드들은 파랑 다음 초록블록을 쌓고 있었고 검증과정을 거쳐 분홍 블록을 초록블록 위에 쌓게됩니다. 

![image-20181028194851519](/Users/veo/Library/Application Support/typora-user-images/image-20181028194851519.png)



결국에는 포르투갈 근처의 노드에서 분기된 블록체인을 만들게 됩니다. 하지만 이런 경우 정보가 갈라지면 안됩니다. 그렇게 되면 결국 이 시스템은 신뢰할 수 없는 시스템이 됩니다. 

그래서 이렇게 충돌했을 때는 누구를 신뢰할 것인가에 대한 규칙이 정해져 있으며 PoW와 이런 규칙들을 통틀어 나카모토 컨센서스라고 합니다. 

여기서 이런 규칙들은 **체인 선택 규칙**이라고 합니다.  즉 블록의 분기가 이루어 질때 어느쪽이 더 길이가 긴쪽이 승리하게 되고 나머지는 고아블록이 됩니다. 

![image-20181028195356473](/Users/veo/Library/Application Support/typora-user-images/image-20181028195356473.png)



물론 블록 생성은 평균 10분이 소요될 정도로 연산량이 큰 작업이므로 이렇게 분기가 발생활 확률은 높지 않습니다. 그리고 이렇게 충돌이 발생하더라도 어느샌가 블록의 길이가 달라져 충돌이 해소가 됩니다. 그래서 실제로는 보통 블록에 5~6개까지 붙으면 안전한 블록으로 판단합니다. 



**완료된 거래 정보의 변경불가**



![image-20181028200343394](/Users/veo/Library/Application Support/typora-user-images/image-20181028200343394.png)

이 그림을 보면 좀 전에 나왔던 비잔티움 장군문제가 떠오르시나요?? 다시 한 번 되짚어 봅시다. 

블록체인의 블록들은 이전 블록의 해쉬정보를 토대로 블록해쉬를 가집니다. 

만약 어떤 거래 정보가 변경된다면 그 거래 정보가 변경된 해당 블록의 해쉬도 변경됩니다. 그럼 그 블록 해쉬정보를 이용했던 다음 블록의 previousHash정보가 변경되기 때문에 다시 채굴을 하여 nonce값을 맞추고 블록해쉬 값을 다시 구해야 합니다. 

즉 거래 정보를 변경한 블록부터 그 이후의 모든 블록을 순서대로 다시 채굴해야 합니다. 이런 악의적인 노드가 바로 앞의 블록의 거래 정보를 변경하고 채굴 하는 동안 다른 선의의 노드들은 거래 정보가 변경되지 않은 원래의 블록체인에 계속 블록을 이어나가게 될 것이고 악의적인 노드와 선의의노드의 길이를 비교하면 악의적인 노드가 더 짧기때문에 고아가 됩니다. 



**51% 공격**

만약 악의적인 노드가 다른 노드들보다 연산 능력이 뛰어난것을 가정해 보겠습니다. 

그렇게 되면 악의적인 노드의 블록체인에 블록이 추가되는 속도가 다른 블록체인에 블록이 추가되는 속도보다 빠르게 될 것이고, 악의적인 노드의 블록체인이 길어질 수 있습니다. 이를 **51%공격**이라고 합니다.

심각한 문제가 아닌가??  

경제적인 관점에서 보면 이런 일이 발생할 가능성은 아주 적습니다. 왜냐하면 거래 정보가 변경된다는 사실이 알려지면 블록체인에 대한 신뢰는 깨지게 됩니다. 

악의 적인 노드 입장에서는 오랫동안 가장 큰 연산능력을 가지고 있었으면 블록이 아주 많을 것입니다. 또 그에 따른 보상액도 많겠죠. 이런 상황에서 블록체인의 신뢰가 깍여 자신이 가지고 있던 비트코인의 가치가 하락한다면?? 즉 자신이 피해를 보게 되는 상황을 만들려고 거래 정보를 변경할 동기는 없는 것입니다. 

여기까지 1. 블록체인의 탄생배경과 분산화된 시스템(블록체인)의 문제점과 해결방안에 대해서 알아보았습니다. 



------



#### 3. 비트코인의 문제점 

지금까지 블록체인의 환경을 비트코인이라는 특정 예를 토대로 살펴보았습니다. 

비트코인은 1세대 블록체인이라고 합니다. 위에서 보신 것처럼 블록체인 환경에서의 이중지불, 비잔티움 문제등  많은 문제들을 해결하기 위해 노력했지만 처음이기 때문에 많은 문제점들을 내포할 수밖에 없었습니다. 무슨 문제점들이 있는지 알아보고 그 문제점들을 해결하기 위해 어떤 노력을 하는지 알아보도록 하겠습니다. 











참고자료 

https://namu.wiki/w/%EC%82%AC%ED%86%A0%EC%8B%9C%20%EB%82%98%EC%B9%B4%EB%AA%A8%ED%86%A0 - 사카시나카모토 나무위키

https://m.blog.naver.com/n_privacy/221221982953 - 네이버 개인정보보호 블로그 

https://homoefficio.github.io/2017/11/19/%EB%B8%94%EB%A1%9D%EC%B2%B4%EC%9D%B8-%ED%95%9C-%EB%B2%88%EC%97%90-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0/ - 블록체인의 이해